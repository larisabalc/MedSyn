{% extends "base.html" %}
{% block title %}My Appointments{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>My Appointments</h2>

    <div class="mb-3 d-flex align-items-center gap-2 flex-wrap">
        <input type="text" id="searchInput" class="form-control" placeholder="Search by doctor, service, specialization" style="max-width: 400px;">

        <div>
            <button id="sortAsc" class="btn btn-secondary btn-sm" title="Sort Ascending">&#9650;</button>
            <button id="sortDesc" class="btn btn-secondary btn-sm" title="Sort Descending">&#9660;</button>
        </div>

        <select id="statusFilter" class="form-select form-select-sm" style="max-width: 150px;">
            <option value="All" selected>All Status</option>
            <option value="Booked">Booked</option>
            <option value="Canceled">Canceled</option>
            <option value="Completed">Completed</option>
        </select>
    </div>

    {% if appointments %}
    <table class="table table-striped" id="appointmentsTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Doctor</th>
                <th>Specialization</th>
                <th>Service</th>
                <th>Notes</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for appt in appointments %}
            <tr>
                <td class="appt-date">{{ appt.availability.availability_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ appt.availability.start_time.strftime('%H:%M') }} - {{ appt.availability.end_time.strftime('%H:%M') }}</td>
                <td class="appt-doctor">{{ appt.doctor.user.username }}</td>
                <td class="appt-spec">{{ appt.doctor.specialization.specialization_name }}</td>
                <td class="appt-service">{{ appt.service.service_name }}</td>
                <td>{{ appt.notes or '-' }}</td>
                <td class="appt-status">
                    {% if appt.status == "Canceled" %}
                        <span class="badge bg-danger">Canceled</span>
                    {% elif appt.status == "Completed" %}
                        <span class="badge bg-success">Completed</span>
                    {% else %}
                        <span class="badge bg-primary">Booked</span>
                    {% endif %}
                </td>
                <td>
                    {% set appt_datetime = appt.availability.availability_date.strftime('%Y-%m-%d') + ' ' + appt.availability.start_time.strftime('%H:%M') %}
                    {% set now = current_time %}
                    {% if appt.status == "Booked" %}
                        <form method="POST" action="{{ url_for('patient.cancel_appointment', appointment_id=appt.appointment_id) }}">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to cancel this appointment?');">Cancel</button>
                        </form>
                    {% else %}
                        <button class="btn btn-secondary btn-sm" disabled>Cancel</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>You have no appointments scheduled.</p>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tableBody = document.querySelector('#appointmentsTable tbody');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const sortAsc = document.getElementById('sortAsc');
        const sortDesc = document.getElementById('sortDesc');

        function filterRows() {
            const filter = searchInput.value.toLowerCase();
            const status = statusFilter.value;
            const rows = tableBody.querySelectorAll('tr');

            rows.forEach(row => {
                const doctor = row.querySelector('.appt-doctor').textContent.toLowerCase();
                const service = row.querySelector('.appt-service').textContent.toLowerCase();
                const spec = row.querySelector('.appt-spec').textContent.toLowerCase();
                const rowStatus = row.querySelector('.appt-status').textContent.trim();

                const matchesSearch = doctor.includes(filter) || service.includes(filter) || spec.includes(filter);
                const matchesStatus = (status === "All") || (rowStatus === status);

                row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
            });
        }

        searchInput.addEventListener('keyup', filterRows);
        statusFilter.addEventListener('change', filterRows);

        function sortTable(ascending = true) {
            const rows = Array.from(tableBody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                const dateA = a.querySelector('.appt-date').textContent.trim();
                const dateB = b.querySelector('.appt-date').textContent.trim();

                const timeA = a.querySelector('td:nth-child(2)').textContent.split('-')[0].trim();
                const timeB = b.querySelector('td:nth-child(2)').textContent.split('-')[0].trim();

                const dateTimeA = new Date(`${dateA}T${timeA}:00`);
                const dateTimeB = new Date(`${dateB}T${timeB}:00`);

                return ascending ? dateTimeA - dateTimeB : dateTimeB - dateTimeA;
            });

            rows.forEach(row => tableBody.appendChild(row));
        }

        sortAsc.addEventListener('click', () => sortTable(true));
        sortDesc.addEventListener('click', () => sortTable(false));
    });
</script>
{% endblock %}
